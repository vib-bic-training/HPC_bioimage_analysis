Bootstrap: docker
From: ubuntu:24.04

%files

%environment
    export NUMBA_CACHE_DIR=/tmp/numba_cache
    export CELLPOSE_LOCAL_MODELS_PATH=/tmp/models
    CONDA_BIN_PATH="/opt/conda/bin"
    export PATH="$CONDA_BIN_PATH:$PATH"

%post
   apt-get update -y
   apt install -y build-essential wget bzip2 qtcreator libxcb-cursor0

   # Install Miniconda
   wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O /tmp/miniconda.sh
   bash /tmp/miniconda.sh -b -p /opt/conda
   rm /tmp/miniconda.sh
   export PATH="/opt/conda/bin:$PATH"

   conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/main
   conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/r
   conda create --yes --name cellpose python=3.10
   /opt/conda/envs/cellpose/bin/pip install cellpose torch torchvision torchaudio --extra-index-url https://download.pytorch.org/whl/cu118

%runscript
    exec /opt/conda/envs/cellpose/bin/"$@"

%labels
    Author Tatiana Woller
    Version 1.0
    Description Cellpose 4 with PyTorch 2.1.0 and CUDA 11.8 support
